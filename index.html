<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Trading Journal</title>
    <style>
        /* DARK THEME - MINIMALIST */
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --border-color: #475569;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        h1 {
            color: var(--accent-blue);
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .system-status {
            background-color: var(--bg-secondary);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid var(--accent-green);
        }

        .system-status.locked {
            border-left-color: var(--accent-red);
            background-color: #7f1d1d20;
        }

        .status-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lock-warning {
            color: var(--accent-red);
            font-weight: bold;
            background-color: #7f1d1d40;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }

        .system-status.locked .lock-warning {
            display: block;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background-color: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border-color);
        }

        .card h2 {
            color: var(--accent-blue);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .price-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .calc-display {
            background-color: var(--bg-tertiary);
            padding: 12px;
            border-radius: 6px;
            margin-top: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .calc-display .positive {
            color: var(--accent-green);
        }

        .calc-display .negative {
            color: var(--accent-red);
        }

        .checklist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .check-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .check-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .grade-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            margin-left: 10px;
        }

        .grade-A {
            background-color: var(--accent-green);
            color: #000;
        }

        .grade-B {
            background-color: var(--accent-yellow);
            color: #000;
        }

        .grade-C {
            background-color: var(--accent-red);
            color: #fff;
        }

        .btn {
            padding: 12px 24px;
            background-color: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background-color: #2563eb;
        }

        .btn:disabled {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .btn-danger {
            background-color: var(--accent-red);
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .screenshot-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .screenshot-area:hover {
            border-color: var(--accent-blue);
        }

        .screenshot-preview {
            max-width: 200px;
            max-height: 150px;
            border-radius: 6px;
            margin: 5px;
            border: 1px solid var(--border-color);
        }

        .screenshot-thumbnails {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .tab-container {
            margin-top: 30px;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 500;
            position: relative;
        }

        .tab.active {
            color: var(--accent-blue);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--accent-blue);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .trade-table {
            width: 100%;
            border-collapse: collapse;
        }

        .trade-table th,
        .trade-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .trade-table th {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            font-weight: 600;
        }

        .trade-table tr:hover {
            background-color: var(--bg-tertiary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background-color: var(--bg-tertiary);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .export-import {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .export-import textarea {
            min-height: 150px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        .pattern-alert {
            background-color: #7f1d1d40;
            border-left: 4px solid var(--accent-red);
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            display: none;
        }

        .pattern-alert.show {
            display: block;
        }

        .pattern-counts {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .pattern-count {
            background-color: var(--bg-tertiary);
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .pattern-count.high {
            border-left: 4px solid var(--accent-red);
        }

        .pattern-count.medium {
            border-left: 4px solid var(--accent-yellow);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Professional Trading Journal</h1>
            <div class="subtitle">Rule-Based ‚Ä¢ Local-First ‚Ä¢ Discipline-Focused</div>
        </header>

        <!-- System Status -->
        <div id="systemStatus" class="system-status">
            <div class="status-content">
                <div>
                    <strong>System Status:</strong> <span id="statusText">Ready</span>
                    <div>Consecutive C-grades: <span id="cGradeCount">0</span></div>
                </div>
                <div id="strictModeIndicator" style="display: none;">
                    <strong>üîí STRICT MODE ACTIVE</strong>
                </div>
            </div>
            <div class="lock-warning">
                ‚ö†Ô∏è Trading locked due to 3 consecutive C-grade trades. Review your trades before continuing.
            </div>
        </div>

        <!-- Main Input Grid -->
        <div class="main-grid">
            <!-- Trade Entry Form -->
            <div class="card">
                <h2>Trade Entry</h2>
                <form id="tradeForm">
                    <!-- Market Info -->
                    <div class="form-group full-width">
                        <label for="market">Market / Pair *</label>
                        <input type="text" id="market" required placeholder="e.g., BTC/USD, EUR/USD">
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="tradingStyle">Trading Style *</label>
                            <select id="tradingStyle" required>
                                <option value="">Select style</option>
                                <option value="Scalp">Scalp</option>
                                <option value="Intraday">Intraday</option>
                                <option value="Swing">Swing</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="emotionalState">Emotional State *</label>
                            <select id="emotionalState" required>
                                <option value="">Select state</option>
                                <option value="Calm">Calm</option>
                                <option value="Confident">Confident</option>
                                <option value="Anxious">Anxious</option>
                                <option value="FOMO">FOMO</option>
                                <option value="Revenge">Revenge Trading</option>
                            </select>
                        </div>
                    </div>

                    <!-- Price Levels -->
                    <div class="form-group full-width">
                        <label>Price Levels *</label>
                        <div class="price-group">
                            <div>
                                <label for="entryPrice">Entry</label>
                                <input type="number" id="entryPrice" step="0.00001" required>
                            </div>
                            <div>
                                <label for="stopLoss">Stop Loss</label>
                                <input type="number" id="stopLoss" step="0.00001" required>
                            </div>
                            <div>
                                <label for="takeProfit">Take Profit</label>
                                <input type="number" id="takeProfit" step="0.00001" required>
                            </div>
                        </div>
                    </div>

                    <!-- Risk Calculation Display -->
                    <div class="form-group full-width">
                        <label>Risk Analysis</label>
                        <div class="calc-display" id="riskCalc">
                            Enter prices to see calculations...
                        </div>
                    </div>

                    <!-- SOP Checklist -->
                    <div class="form-group full-width">
                        <label>SOP Checklist</label>
                        <div class="checklist-grid">
                            <div class="check-item">
                                <input type="checkbox" id="check1" value="sessionValid">
                                <label for="check1">Session valid</label>
                            </div>
                            <div class="check-item">
                                <input type="checkbox" id="check2" value="noHighImpactNews">
                                <label for="check2">No high-impact news</label>
                            </div>
                            <div class="check-item">
                                <input type="checkbox" id="check3" value="htfBiasClear">
                                <label for="check3">HTF bias clear</label>
                            </div>
                            <div class="check-item">
                                <input type="checkbox" id="check4" value="liquiditySweep">
                                <label for="check4">Liquidity sweep</label>
                            </div>
                            <div class="check-item">
                                <input type="checkbox" id="check5" value="engulfingValid">
                                <label for="check5">Engulfing valid</label>
                            </div>
                            <div class="check-item">
                                <input type="checkbox" id="check6" value="engulfingFail">
                                <label for="check6">Engulfing fail</label>
                            </div>
                            <div class="check-item">
                                <input type="checkbox" id="check7" value="entryConfirmation">
                                <label for="check7">Entry confirmation</label>
                            </div>
                        </div>
                    </div>

                    <!-- Screenshot Upload -->
                    <div class="form-group full-width">
                        <label>Screenshots</label>
                        <div class="screenshot-area" id="screenshotDropArea">
                            <div>üì∑ Drop screenshots here or click to select</div>
                            <input type="file" id="screenshotInput" accept="image/*" multiple style="display: none;">
                            <div class="screenshot-thumbnails" id="screenshotPreviews"></div>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div class="form-group full-width">
                        <button type="submit" class="btn" id="saveBtn">Save Trade</button>
                    </div>
                </form>
            </div>

            <!-- Trade Evaluation -->
            <div class="card">
                <h2>Trade Evaluation</h2>
                
                <!-- Score Display -->
                <div class="form-group">
                    <label>Checklist Score</label>
                    <div class="calc-display">
                        <div>Score: <span id="scoreValue">0</span></div>
                        <div>Grade: <span id="gradeValue">-</span> <span id="gradeBadge" class="grade-badge"></span></div>
                    </div>
                </div>

                <!-- R-Result -->
                <div class="form-group">
                    <label>R-Result</label>
                    <div class="calc-display">
                        <div>R Result: <span id="rResult">-</span>R</div>
                        <div id="rLogic">Logic will appear here</div>
                    </div>
                </div>

                <!-- Pattern Detection -->
                <div class="form-group">
                    <label>Pattern Detection</label>
                    <div class="pattern-counts" id="patternCounts">
                        <!-- Filled by JavaScript -->
                    </div>
                    <div class="pattern-alert" id="patternAlert">
                        ‚ö†Ô∏è Pattern detected: Consider reviewing your strategy
                    </div>
                </div>

                <!-- Data Management -->
                <div class="form-group">
                    <label>Data Management</label>
                    <div class="export-import">
                        <button type="button" class="btn" onclick="exportData()">Export All Data</button>
                        <button type="button" class="btn btn-danger" onclick="confirmImport()">Import Data</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Tabs -->
        <div class="tab-container">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('history')">Trade History</button>
                <button class="tab" onclick="switchTab('analytics')">Analytics</button>
                <button class="tab" onclick="switchTab('weekly')">Weekly Review</button>
            </div>

            <!-- Trade History Tab -->
            <div id="historyTab" class="tab-content active">
                <div class="card">
                    <h2>Trade History</h2>
                    <div style="overflow-x: auto;">
                        <table class="trade-table" id="tradeTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Market</th>
                                    <th>Style</th>
                                    <th>Entry</th>
                                    <th>SL</th>
                                    <th>TP</th>
                                    <th>RR</th>
                                    <th>Score</th>
                                    <th>Grade</th>
                                    <th>R</th>
                                    <th>Emotion</th>
                                </tr>
                            </thead>
                            <tbody id="tradeTableBody">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analyticsTab" class="tab-content">
                <div class="card">
                    <h2>Performance Analytics</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div>Total Trades</div>
                            <div class="stat-value" id="totalTrades">0</div>
                        </div>
                        <div class="stat-card">
                            <div>Win Rate</div>
                            <div class="stat-value" id="winRate">0%</div>
                        </div>
                        <div class="stat-card">
                            <div>Avg R</div>
                            <div class="stat-value" id="avgR">0.00</div>
                        </div>
                        <div class="stat-card">
                            <div>Total R</div>
                            <div class="stat-value" id="totalR">0.00</div>
                        </div>
                    </div>

                    <div style="margin-top: 30px;">
                        <h3>Performance by Pair</h3>
                        <table class="trade-table">
                            <thead>
                                <tr>
                                    <th>Market</th>
                                    <th>Trades</th>
                                    <th>Win Rate</th>
                                    <th>Avg R</th>
                                </tr>
                            </thead>
                            <tbody id="pairStats">
                                <!-- Filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Weekly Review Tab -->
            <div id="weeklyTab" class="tab-content">
                <div class="card">
                    <h2>Weekly Review</h2>
                    <div id="weeklyStats">
                        <!-- Filled by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 1000;">
        <div style="background-color: var(--bg-secondary); margin: 50px auto; padding: 30px; border-radius: 12px; max-width: 600px;">
            <h3>Import Trade Data</h3>
            <textarea id="importData" placeholder="Paste your exported JSON data here..." style="width: 100%; min-height: 200px; margin: 20px 0;"></textarea>
            <div style="display: flex; gap: 15px;">
                <button class="btn" onclick="importData()">Import</button>
                <button class="btn btn-danger" onclick="document.getElementById('importModal').style.display='none'">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ============================
        // GLOBAL STATE & CONFIGURATION
        // ============================
        const TRADE_STORAGE_KEY = 'professional_trading_journal';
        const CONFIG_STORAGE_KEY = 'trading_journal_config';
        
        // Scoring rules - explicit and deterministic
        const SCORING_RULES = {
            sessionValid: 0, // Base requirement, no score
            noHighImpactNews: 1,
            htfBiasClear: 1,
            liquiditySweep: 2,
            engulfingValid: 1,
            engulfingFail: -2,
            entryConfirmation: 1
        };

        // Grading thresholds - explicit and deterministic
        const GRADE_THRESHOLDS = {
            A: 4,  // High quality
            B: 2,  // Medium quality
            C: 0   // Low quality
        };

        // R-Result rules - explicit and deterministic
        const R_RESULT_RULES = [
            { condition: (grade, rr) => grade === 'A' && rr >= 1.5, result: 1.0 },
            { condition: (grade, rr) => grade === 'A' && rr >= 1.0, result: 0.7 },
            { condition: (grade, rr) => grade === 'B' && rr >= 1.5, result: 0.5 },
            { condition: (grade, rr) => grade === 'B' && rr >= 1.0, result: 0.3 },
            { condition: (grade, rr) => grade === 'C' && rr >= 1.0, result: 0.1 },
            { condition: (grade, rr) => grade === 'C' && rr < 1.0, result: -0.5 },
            { condition: (grade, rr) => grade === 'C' && rr < 0.5, result: -1.0 },
            // Default rule
            { condition: () => true, result: 0 }
        ];

        // Strict mode configuration
        const STRICT_MODE_CONFIG = {
            consecutiveCGrades: 3,
            lockDuration: null // null means manual unlock
        };

        // Pattern detection thresholds
        const PATTERN_THRESHOLDS = {
            fomoTrades: 2,     // 2+ FOMO trades in last 5 trades
            lowRR: 3,         // 3+ trades with RR < 1.0
            consecutiveLosses: 2 // 2+ consecutive negative R results
        };

        // Global state
        let trades = [];
        let systemConfig = {
            strictModeLocked: false,
            consecutiveCGrades: 0,
            patternCounts: {
                fomoTrades: 0,
                lowRR: 0,
                consecutiveLosses: 0
            }
        };
        let currentScreenshots = [];

        // ============================
        // INITIALIZATION
        // ============================
        function init() {
            loadData();
            setupEventListeners();
            updateUI();
            updateRiskCalc();
            updatePatternDetection();
        }

        // ============================
        // DATA MANAGEMENT
        // ============================
        function loadData() {
            // Load trades
            const tradesData = localStorage.getItem(TRADE_STORAGE_KEY);
            if (tradesData) {
                trades = JSON.parse(tradesData);
                // Convert date strings back to Date objects
                trades.forEach(trade => {
                    trade.date = new Date(trade.date);
                });
            }

            // Load system config
            const configData = localStorage.getItem(CONFIG_STORAGE_KEY);
            if (configData) {
                systemConfig = JSON.parse(configData);
            }

            updateStrictMode();
        }

        function saveData() {
            localStorage.setItem(TRADE_STORAGE_KEY, JSON.stringify(trades));
            localStorage.setItem(CONFIG_STORAGE_KEY, JSON.stringify(systemConfig));
        }

        function exportData() {
            const exportData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                trades: trades,
                systemConfig: systemConfig
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `trading-journal-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function confirmImport() {
            document.getElementById('importModal').style.display = 'block';
            document.getElementById('importData').value = '';
            document.getElementById('importData').focus();
        }

        function importData() {
            const importText = document.getElementById('importData').value;
            
            try {
                const importData = JSON.parse(importText);
                
                if (!importData.trades || !Array.isArray(importData.trades)) {
                    throw new Error('Invalid data format: trades array missing');
                }

                // Validate trade structure
                const requiredFields = ['date', 'market', 'tradingStyle', 'entry', 'stopLoss', 'takeProfit'];
                for (const trade of importData.trades) {
                    for (const field of requiredFields) {
                        if (!trade[field]) {
                            throw new Error(`Invalid trade: missing ${field}`);
                        }
                    }
                }

                trades = importData.trades;
                systemConfig = importData.systemConfig || systemConfig;
                
                // Convert date strings to Date objects
                trades.forEach(trade => {
                    trade.date = new Date(trade.date);
                });

                saveData();
                updateUI();
                document.getElementById('importModal').style.display = 'none';
                alert(`Successfully imported ${trades.length} trades`);
            } catch (error) {
                alert(`Import failed: ${error.message}`);
            }
        }

        // ============================
        // TRADE VALIDATION & CALCULATION
        // ============================
        function validateTrade(formData) {
            const errors = [];

            // Required fields
            if (!formData.market) errors.push('Market is required');
            if (!formData.tradingStyle) errors.push('Trading style is required');
            if (!formData.emotionalState) errors.push('Emotional state is required');
            if (!formData.entry) errors.push('Entry price is required');
            if (!formData.stopLoss) errors.push('Stop loss is required');
            if (!formData.takeProfit) errors.push('Take profit is required');

            // Price validation
            if (formData.entry && formData.stopLoss) {
                if (Math.abs(formData.entry - formData.stopLoss) < 0.00001) {
                    errors.push('Entry price must be different from stop loss');
                }
                if (formData.entry <= 0 || formData.stopLoss <= 0 || formData.takeProfit <= 0) {
                    errors.push('Prices must be positive');
                }
            }

            return errors;
        }

        function calculateRiskMetrics(entry, stopLoss, takeProfit) {
            // Absolute risk and reward
            const risk = Math.abs(entry - stopLoss);
            const reward = Math.abs(takeProfit - entry);
            
            // Risk:Reward ratio
            const rr = risk > 0 ? (reward / risk).toFixed(2) : 0;
            
            return { risk, reward, rr };
        }

        // ============================
        // SCORING & GRADING LOGIC
        // ============================
        function calculateScore(checklist) {
            let score = 0;
            let logic = [];

            // Calculate score based on checklist
            for (const [key, value] of Object.entries(checklist)) {
                if (value) {
                    const points = SCORING_RULES[key] || 0;
                    score += points;
                    if (points !== 0) {
                        logic.push(`${key}: ${points > 0 ? '+' : ''}${points}`);
                    }
                }
            }

            // Determine grade
            let grade = 'C'; // Default to lowest grade
            if (score >= GRADE_THRESHOLDS.A) {
                grade = 'A';
            } else if (score >= GRADE_THRESHOLDS.B) {
                grade = 'B';
            }

            return { score, grade, logic: logic.join(', ') };
        }

        function calculateRResult(grade, rr, checklist) {
            // Apply R-result rules in order
            for (const rule of R_RESULT_RULES) {
                if (rule.condition(grade, parseFloat(rr), checklist)) {
                    return rule.result;
                }
            }
            return 0;
        }

        // ============================
        // STRICT MODE LOGIC
        // ============================
        function updateStrictMode() {
            // Count consecutive C-grade trades
            let consecutiveC = 0;
            for (let i = trades.length - 1; i >= 0; i--) {
                if (trades[i].grade === 'C') {
                    consecutiveC++;
                } else {
                    break;
                }
            }

            systemConfig.consecutiveCGrades = consecutiveC;
            
            // Check if strict mode should be activated
            if (consecutiveC >= STRICT_MODE_CONFIG.consecutiveCGrades) {
                systemConfig.strictModeLocked = true;
            } else {
                systemConfig.strictModeLocked = false;
            }

            saveData();
            updateStrictModeUI();
        }

        function unlockStrictMode() {
            systemConfig.strictModeLocked = false;
            saveData();
            updateStrictModeUI();
        }

        // ============================
        // PATTERN DETECTION
        // ============================
        function detectPatterns() {
            if (trades.length === 0) return;

            const recentTrades = trades.slice(-5); // Last 5 trades
            const counts = {
                fomoTrades: 0,
                lowRR: 0,
                consecutiveLosses: 0
            };

            // Count FOMO trades
            counts.fomoTrades = recentTrades.filter(t => 
                t.emotionalState === 'FOMO'
            ).length;

            // Count low RR trades
            counts.lowRR = recentTrades.filter(t => 
                parseFloat(t.rr) < 1.0
            ).length;

            // Count consecutive losses
            let currentLossStreak = 0;
            for (let i = trades.length - 1; i >= 0; i--) {
                if (trades[i].rResult < 0) {
                    currentLossStreak++;
                } else {
                    break;
                }
            }
            counts.consecutiveLosses = currentLossStreak;

            systemConfig.patternCounts = counts;
            return counts;
        }

        // ============================
        // SCREENSHOT HANDLING
        // ============================
        function handleScreenshotUpload(files) {
            const promises = [];
            
            for (const file of files) {
                if (!file.type.startsWith('image/')) continue;
                
                const promise = new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        resolve({
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            data: e.target.result,
                            timestamp: new Date().toISOString()
                        });
                    };
                    reader.readAsDataURL(file);
                });
                
                promises.push(promise);
            }

            Promise.all(promises).then(screenshots => {
                currentScreenshots = [...currentScreenshots, ...screenshots];
                updateScreenshotPreviews();
            });
        }

        function removeScreenshot(index) {
            currentScreenshots.splice(index, 1);
            updateScreenshotPreviews();
        }

        // ============================
        // UI UPDATES
        // ============================
        function updateUI() {
            updateTradeTable();
            updateAnalytics();
            updateWeeklyReview();
            updateStrictModeUI();
            updatePatternDetection();
        }

        function updateRiskCalc() {
            const entry = parseFloat(document.getElementById('entryPrice').value);
            const stopLoss = parseFloat(document.getElementById('stopLoss').value);
            const takeProfit = parseFloat(document.getElementById('takeProfit').value);

            if (!isNaN(entry) && !isNaN(stopLoss) && !isNaN(takeProfit)) {
                const metrics = calculateRiskMetrics(entry, stopLoss, takeProfit);
                
                let rrClass = 'positive';
                if (metrics.rr < 1.0) rrClass = 'negative';
                else if (metrics.rr < 1.5) rrClass = '';

                document.getElementById('riskCalc').innerHTML = `
                    Risk: ${metrics.risk.toFixed(5)} | 
                    Reward: ${metrics.reward.toFixed(5)} | 
                    R:R: <span class="${rrClass}">${metrics.rr}</span>
                `;
            }
        }

        function updateTradeTable() {
            const tbody = document.getElementById('tradeTableBody');
            tbody.innerHTML = '';

            // Sort trades by date (newest first)
            const sortedTrades = [...trades].sort((a, b) => b.date - a.date);

            for (const trade of sortedTrades) {
                const row = document.createElement('tr');
                
                // Format date
                const dateStr = trade.date.toLocaleDateString() + ' ' + 
                               trade.date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                // Determine RR class
                let rrClass = '';
                if (trade.rr >= 1.5) rrClass = 'positive';
                else if (trade.rr < 1.0) rrClass = 'negative';

                // Determine R class
                let rClass = '';
                if (trade.rResult > 0) rClass = 'positive';
                else if (trade.rResult < 0) rClass = 'negative';

                row.innerHTML = `
                    <td>${dateStr}</td>
                    <td>${trade.market}</td>
                    <td>${trade.tradingStyle}</td>
                    <td>${trade.entry.toFixed(5)}</td>
                    <td>${trade.stopLoss.toFixed(5)}</td>
                    <td>${trade.takeProfit.toFixed(5)}</td>
                    <td class="${rrClass}">${trade.rr}</td>
                    <td>${trade.score}</td>
                    <td><span class="grade-badge grade-${trade.grade}">${trade.grade}</span></td>
                    <td class="${rClass}">${trade.rResult.toFixed(1)}R</td>
                    <td>${trade.emotionalState}</td>
                `;
                tbody.appendChild(row);
            }
        }

        function updateAnalytics() {
            if (trades.length === 0) {
                document.getElementById('totalTrades').textContent = '0';
                document.getElementById('winRate').textContent = '0%';
                document.getElementById('avgR').textContent = '0.00';
                document.getElementById('totalR').textContent = '0.00';
                document.getElementById('pairStats').innerHTML = '<tr><td colspan="4">No trades yet</td></tr>';
                return;
            }

            // Basic stats
            const totalTrades = trades.length;
            const winningTrades = trades.filter(t => t.rResult > 0).length;
            const winRate = ((winningTrades / totalTrades) * 100).toFixed(1);
            const totalR = trades.reduce((sum, t) => sum + t.rResult, 0);
            const avgR = (totalR / totalTrades).toFixed(2);

            document.getElementById('totalTrades').textContent = totalTrades;
            document.getElementById('winRate').textContent = `${winRate}%`;
            document.getElementById('avgR').textContent = avgR;
            document.getElementById('totalR').textContent = totalR.toFixed(2);

            // Pair stats
            const pairMap = {};
            trades.forEach(trade => {
                if (!pairMap[trade.market]) {
                    pairMap[trade.market] = {
                        trades: 0,
                        wins: 0,
                        totalR: 0
                    };
                }
                pairMap[trade.market].trades++;
                if (trade.rResult > 0) pairMap[trade.market].wins++;
                pairMap[trade.market].totalR += trade.rResult;
            });

            const pairStatsBody = document.getElementById('pairStats');
            pairStatsBody.innerHTML = '';

            for (const [pair, stats] of Object.entries(pairMap)) {
                const winRate = stats.trades > 0 ? ((stats.wins / stats.trades) * 100).toFixed(1) : '0.0';
                const avgR = stats.trades > 0 ? (stats.totalR / stats.trades).toFixed(2) : '0.00';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${pair}</td>
                    <td>${stats.trades}</td>
                    <td>${winRate}%</td>
                    <td>${avgR}</td>
                `;
                pairStatsBody.appendChild(row);
            }
        }

        function updateWeeklyReview() {
            const weeklyStats = document.getElementById('weeklyStats');
            
            if (trades.length === 0) {
                weeklyStats.innerHTML = '<p>No trades this week</p>';
                return;
            }

            // Get trades from last 7 days
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            const weeklyTrades = trades.filter(t => t.date >= oneWeekAgo);
            
            if (weeklyTrades.length === 0) {
                weeklyStats.innerHTML = '<p>No trades this week</p>';
                return;
            }

            const weeklyStatsObj = {
                totalTrades: weeklyTrades.length,
                winningTrades: weeklyTrades.filter(t => t.rResult > 0).length,
                totalR: weeklyTrades.reduce((sum, t) => sum + t.rResult, 0),
                avgGrade: calculateAverageGrade(weeklyTrades),
                mostTradedPair: getMostTradedPair(weeklyTrades),
                emotionalStateCount: countEmotionalStates(weeklyTrades)
            };

            const winRate = weeklyStatsObj.totalTrades > 0 ? 
                ((weeklyStatsObj.winningTrades / weeklyStatsObj.totalTrades) * 100).toFixed(1) : '0.0';

            weeklyStats.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div>Weekly Trades</div>
                        <div class="stat-value">${weeklyStatsObj.totalTrades}</div>
                    </div>
                    <div class="stat-card">
                        <div>Weekly Win Rate</div>
                        <div class="stat-value">${winRate}%</div>
                    </div>
                    <div class="stat-card">
                        <div>Weekly R</div>
                        <div class="stat-value">${weeklyStatsObj.totalR.toFixed(2)}</div>
                    </div>
                    <div class="stat-card">
                        <div>Avg Grade</div>
                        <div class="stat-value">${weeklyStatsObj.avgGrade}</div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <p><strong>Most Traded Pair:</strong> ${weeklyStatsObj.mostTradedPair.pair} (${weeklyStatsObj.mostTradedPair.count} trades)</p>
                    <p><strong>Emotional State Breakdown:</strong> ${formatEmotionalStates(weeklyStatsObj.emotionalStateCount)}</p>
                </div>
            `;
        }

        function calculateAverageGrade(trades) {
            const gradeValues = { A: 3, B: 2, C: 1 };
            const total = trades.reduce((sum, t) => sum + (gradeValues[t.grade] || 0), 0);
            const avg = total / trades.length;
            
            if (avg >= 2.5) return 'A';
            if (avg >= 1.5) return 'B';
            return 'C';
        }

        function getMostTradedPair(trades) {
            const pairCount = {};
            trades.forEach(t => {
                pairCount[t.market] = (pairCount[t.market] || 0) + 1;
            });
            
            const maxPair = Object.entries(pairCount).reduce((max, [pair, count]) => 
                count > max.count ? { pair, count } : max, 
                { pair: 'None', count: 0 }
            );
            
            return maxPair;
        }

        function countEmotionalStates(trades) {
            const counts = {};
            trades.forEach(t => {
                counts[t.emotionalState] = (counts[t.emotionalState] || 0) + 1;
            });
            return counts;
        }

        function formatEmotionalStates(counts) {
            return Object.entries(counts)
                .map(([state, count]) => `${state}: ${count}`)
                .join(', ');
        }

        function updateStrictModeUI() {
            const statusElement = document.getElementById('systemStatus');
            const statusText = document.getElementById('statusText');
            const cGradeCount = document.getElementById('cGradeCount');
            const strictModeIndicator = document.getElementById('strictModeIndicator');
            const saveBtn = document.getElementById('saveBtn');

            cGradeCount.textContent = systemConfig.consecutiveCGrades;

            if (systemConfig.strictModeLocked) {
                statusElement.classList.add('locked');
                statusText.textContent = 'LOCKED';
                strictModeIndicator.style.display = 'block';
                saveBtn.disabled = true;
                saveBtn.textContent = 'Trading Locked';
            } else {
                statusElement.classList.remove('locked');
                statusText.textContent = 'Ready';
                strictModeIndicator.style.display = 'none';
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Trade';
            }
        }

        function updateScreenshotPreviews() {
            const previewsContainer = document.getElementById('screenshotPreviews');
            previewsContainer.innerHTML = '';

            currentScreenshots.forEach((screenshot, index) => {
                const preview = document.createElement('img');
                preview.src = screenshot.data;
                preview.className = 'screenshot-preview';
                preview.title = screenshot.name;
                
                const container = document.createElement('div');
                container.style.position = 'relative';
                container.style.display = 'inline-block';
                
                const removeBtn = document.createElement('button');
                removeBtn.textContent = '√ó';
                removeBtn.style.position = 'absolute';
                removeBtn.style.top = '5px';
                removeBtn.style.right = '5px';
                removeBtn.style.background = 'var(--accent-red)';
                removeBtn.style.color = 'white';
                removeBtn.style.border = 'none';
                removeBtn.style.borderRadius = '50%';
                removeBtn.style.width = '20px';
                removeBtn.style.height = '20px';
                removeBtn.style.cursor = 'pointer';
                removeBtn.style.fontSize = '12px';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeScreenshot(index);
                };
                
                container.appendChild(preview);
                container.appendChild(removeBtn);
                previewsContainer.appendChild(container);
            });
        }

        function updatePatternDetection() {
            const counts = detectPatterns();
            const patternCountsEl = document.getElementById('patternCounts');
            const patternAlert = document.getElementById('patternAlert');
            
            patternCountsEl.innerHTML = '';
            
            let showAlert = false;
            
            // FOMO trades pattern
            const fomoClass = counts.fomoTrades >= PATTERN_THRESHOLDS.fomoTrades ? 'high' : 
                             counts.fomoTrades > 0 ? 'medium' : '';
            patternCountsEl.innerHTML += `
                <div class="pattern-count ${fomoClass}">
                    FOMO Trades: ${counts.fomoTrades}
                </div>
            `;
            if (counts.fomoTrades >= PATTERN_THRESHOLDS.fomoTrades) showAlert = true;
            
            // Low RR pattern
            const lowRRClass = counts.lowRR >= PATTERN_THRESHOLDS.lowRR ? 'high' : 
                              counts.lowRR > 0 ? 'medium' : '';
            patternCountsEl.innerHTML += `
                <div class="pattern-count ${lowRRClass}">
                    Low RR Trades: ${counts.lowRR}
                </div>
            `;
            if (counts.lowRR >= PATTERN_THRESHOLDS.lowRR) showAlert = true;
            
            // Consecutive losses pattern
            const lossClass = counts.consecutiveLosses >= PATTERN_THRESHOLDS.consecutiveLosses ? 'high' : 
                             counts.consecutiveLosses > 0 ? 'medium' : '';
            patternCountsEl.innerHTML += `
                <div class="pattern-count ${lossClass}">
                    Consecutive Losses: ${counts.consecutiveLosses}
                </div>
            `;
            if (counts.consecutiveLosses >= PATTERN_THRESHOLDS.consecutiveLosses) showAlert = true;
            
            // Show alert if any pattern detected
            patternAlert.classList.toggle('show', showAlert);
        }

        function updateEvaluation() {
            // Get checklist values
            const checklist = {
                sessionValid: document.getElementById('check1').checked,
                noHighImpactNews: document.getElementById('check2').checked,
                htfBiasClear: document.getElementById('check3').checked,
                liquiditySweep: document.getElementById('check4').checked,
                engulfingValid: document.getElementById('check5').checked,
                engulfingFail: document.getElementById('check6').checked,
                entryConfirmation: document.getElementById('check7').checked
            };

            // Calculate score and grade
            const { score, grade, logic: scoreLogic } = calculateScore(checklist);
            
            // Calculate RR
            const entry = parseFloat(document.getElementById('entryPrice').value);
            const stopLoss = parseFloat(document.getElementById('stopLoss').value);
            const takeProfit = parseFloat(document.getElementById('takeProfit').value);
            let rr = 0;
            
            if (!isNaN(entry) && !isNaN(stopLoss) && !isNaN(takeProfit)) {
                const metrics = calculateRiskMetrics(entry, stopLoss, takeProfit);
                rr = parseFloat(metrics.rr);
            }

            // Calculate R result
            const rResult = calculateRResult(grade, rr, checklist);
            
            // Update UI
            document.getElementById('scoreValue').textContent = score;
            document.getElementById('gradeValue').textContent = grade;
            
            const gradeBadge = document.getElementById('gradeBadge');
            gradeBadge.textContent = grade;
            gradeBadge.className = `grade-badge grade-${grade}`;
            
            document.getElementById('rResult').textContent = rResult.toFixed(1);
            
            // Show logic
            const rLogic = document.getElementById('rLogic');
            rLogic.textContent = `Grade: ${grade}, RR: ${rr.toFixed(2)} ‚Üí ${rResult.toFixed(1)}R`;
        }

        // ============================
        // EVENT HANDLING
        // ============================
        function setupEventListeners() {
            // Trade form submission
            document.getElementById('tradeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveTrade();
            });

            // Price input listeners for real-time calculation
            ['entryPrice', 'stopLoss', 'takeProfit'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateRiskCalc);
                document.getElementById(id).addEventListener('input', updateEvaluation);
            });

            // Checklist listeners for real-time evaluation
            for (let i = 1; i <= 7; i++) {
                document.getElementById(`check${i}`).addEventListener('change', updateEvaluation);
            }

            // Screenshot handling
            const screenshotInput = document.getElementById('screenshotInput');
            const screenshotDropArea = document.getElementById('screenshotDropArea');

            screenshotDropArea.addEventListener('click', () => {
                screenshotInput.click();
            });

            screenshotInput.addEventListener('change', (e) => {
                handleScreenshotUpload(Array.from(e.target.files));
            });

            screenshotDropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                screenshotDropArea.style.borderColor = 'var(--accent-blue)';
            });

            screenshotDropArea.addEventListener('dragleave', () => {
                screenshotDropArea.style.borderColor = 'var(--border-color)';
            });

            screenshotDropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                screenshotDropArea.style.borderColor = 'var(--border-color)';
                handleScreenshotUpload(Array.from(e.dataTransfer.files));
            });

            // Form field listeners for evaluation updates
            document.getElementById('tradingStyle').addEventListener('change', updateEvaluation);
            document.getElementById('emotionalState').addEventListener('change', updateEvaluation);
        }

        function saveTrade() {
            // Check if system is locked
            if (systemConfig.strictModeLocked) {
                alert('Trading is locked due to 3 consecutive C-grade trades. Please review your trades.');
                return;
            }

            // Collect form data
            const formData = {
                market: document.getElementById('market').value.trim(),
                tradingStyle: document.getElementById('tradingStyle').value,
                emotionalState: document.getElementById('emotionalState').value,
                entry: parseFloat(document.getElementById('entryPrice').value),
                stopLoss: parseFloat(document.getElementById('stopLoss').value),
                takeProfit: parseFloat(document.getElementById('takeProfit').value)
            };

            // Validate
            const errors = validateTrade(formData);
            if (errors.length > 0) {
                alert('Please fix the following errors:\n' + errors.join('\n'));
                return;
            }

            // Get checklist values
            const checklist = {
                sessionValid: document.getElementById('check1').checked,
                noHighImpactNews: document.getElementById('check2').checked,
                htfBiasClear: document.getElementById('check3').checked,
                liquiditySweep: document.getElementById('check4').checked,
                engulfingValid: document.getElementById('check5').checked,
                engulfingFail: document.getElementById('check6').checked,
                entryConfirmation: document.getElementById('check7').checked
            };

            // Calculate risk metrics
            const metrics = calculateRiskMetrics(formData.entry, formData.stopLoss, formData.takeProfit);

            // Calculate score and grade
            const { score, grade } = calculateScore(checklist);

            // Calculate R result
            const rResult = calculateRResult(grade, metrics.rr, checklist);

            // Create trade object
            const trade = {
                id: Date.now(), // Simple unique ID
                date: new Date(),
                market: formData.market,
                tradingStyle: formData.tradingStyle,
                emotionalState: formData.emotionalState,
                entry: formData.entry,
                stopLoss: formData.stopLoss,
                takeProfit: formData.takeProfit,
                risk: metrics.risk,
                reward: metrics.reward,
                rr: metrics.rr,
                checklist: checklist,
                score: score,
                grade: grade,
                rResult: rResult,
                screenshots: [...currentScreenshots]
            };

            // Add to trades array
            trades.push(trade);

            // Reset form
            document.getElementById('tradeForm').reset();
            currentScreenshots = [];
            updateScreenshotPreviews();

            // Update system state
            updateStrictMode();
            
            // Save data and update UI
            saveData();
            updateUI();
            updateRiskCalc();
            updateEvaluation();

            alert('Trade saved successfully!');
        }

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}Tab`).classList.add('active');
            
            // Activate selected tab button
            event.target.classList.add('active');
        }

        // ============================
        // INITIALIZE APPLICATION
        // ============================
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
  </html>
